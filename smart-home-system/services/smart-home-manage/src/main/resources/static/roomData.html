<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>æˆ¿é—´ä¼ æ„Ÿå™¨æ•°æ®å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f6f9; margin: 0; }
        header { background-color: #3f51b5; color: white; padding: 16px; font-size: 20px; text-align: center; position: relative; }
        .container { padding: 20px; }
        .chart-container { margin-top: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        #charts > div { height: 400px; margin-bottom: 40px; position: relative; }
        a { color: white; text-decoration: none; background: #607d8b; padding: 6px 12px; border-radius: 4px; }
        .alarm { position: absolute; top: 10px; right: 10px; color: white; font-weight: bold; background: rgba(0, 0, 0, 0.7); padding: 6px 12px; border-radius: 4px; font-size: 14px; }

        /* é—ªçƒåŠ¨ç”» */
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }

        .blink {
            animation: blink 1s infinite;  /* è®¾ç½®é—ªçƒåŠ¨ç”» */
        }
    </style>
</head>
<body>
<header>
    <div style="position: absolute; left: 20px; top: 16px;">
        <a id="backBtn" href="#">ğŸ”™ è¿”å›</a>
    </div>
    ğŸ“ˆ æˆ¿é—´ä¼ æ„Ÿå™¨æ•°æ®å¯è§†åŒ–
</header>

<div class="container">
    <h2 id="roomTitle">åŠ è½½ä¸­...</h2>
    <div id="charts" class="chart-container">
        <div id="tempChart"></div>
        <div id="humidityChart"></div>
        <div id="lightChart"></div>
    </div>
</div>

<script>
    // ä»URLä¸­è·å–æˆ¿é—´ID
    const roomId = new URLSearchParams(location.search).get("roomId");

    // é…ç½®æ¯ä¸ªä¼ æ„Ÿå™¨çš„å›¾è¡¨IDã€åç§°å’Œç±»å‹
    const chartConfigs = [
        { id: 'tempChart', name: 'æ¸©åº¦', sensorType: 'temperature' },
        { id: 'humidityChart', name: 'æ¹¿åº¦', sensorType: 'humidity' },
        { id: 'lightChart', name: 'å…‰ç…§', sensorType: 'light' }
    ];

    // è·å–æŒ‡å®šæˆ¿é—´å’Œä¼ æ„Ÿå™¨ç±»å‹çš„æ•°æ®
    async function fetchSensorData(sensorType) {
        const res = await fetch(`/api/sensors/room/${roomId}/${sensorType}`);
        return await res.json();
    }

    // è·å–è¯¥æˆ¿é—´çš„é˜ˆå€¼é…ç½®ï¼ˆå¦‚é«˜ä½é˜ˆå€¼ï¼‰
    async function fetchThresholds() {
        const res = await fetch(`/api/thresholds/room/${roomId}`);
        return await res.json();
    }

    // æ¸²æŸ“å›¾è¡¨çš„å‡½æ•°
    function renderChart(domId, title, dataList, thresholds = {}) {
        const chartDom = document.getElementById(domId);
        if (!chartDom) {
            console.error(`å…ƒç´  #${domId} ä¸å­˜åœ¨ï¼`);
            return;
        }

        const myChart = echarts.init(chartDom);

        // æ ¼å¼åŒ–æ—¶é—´å’Œä¼ æ„Ÿå™¨å€¼æ•°æ®
        const times = dataList.map(d => new Date(d.createdAt).toLocaleTimeString());
        const values = dataList.map(d => parseFloat(d.sensorValue));

        const markLines = [];

        // å¦‚æœå­˜åœ¨ä½é˜ˆå€¼ï¼Œæ·»åŠ æ ‡è®°çº¿
        if (thresholds.lowThresholdValue != null) {
            markLines.push({
                yAxis: thresholds.lowThresholdValue,
                name: 'ä½é˜ˆå€¼',
                lineStyle: {
                    color: '#2196f3',
                    type: 'dashed',
                    width: 2
                },
                label: {
                    formatter: 'ä½é˜ˆå€¼: {c}',
                    position: 'end'
                }
            });
        }

        // å¦‚æœå­˜åœ¨é«˜é˜ˆå€¼ï¼Œæ·»åŠ æ ‡è®°çº¿
        if (thresholds.highThresholdValue != null) {
            markLines.push({
                yAxis: thresholds.highThresholdValue,
                name: 'é«˜é˜ˆå€¼',
                lineStyle: {
                    color: '#f44336',
                    type: 'dashed',
                    width: 2
                },
                label: {
                    formatter: 'é«˜é˜ˆå€¼: {c}',
                    position: 'end'
                }
            });
        }

        // é…ç½®å›¾è¡¨çš„å„é¡¹å‚æ•°
        const option = {
            title: {
                text: title,
                left: 'center',
                top: '10px',
                subtext: `ä½é˜ˆå€¼: ${thresholds.lowThresholdValue ?? 'æœªè®¾ç½®'} | é«˜é˜ˆå€¼: ${thresholds.highThresholdValue ?? 'æœªè®¾ç½®'}`,
                subtextStyle: { fontSize: 14, color: '#333', fontWeight: 'normal' }
            },
            tooltip: { trigger: 'axis' },
            xAxis: {
                type: 'category',
                data: times,
                name: 'æ—¶é—´',
                boundaryGap: false
            },
            yAxis: {
                type: 'value',
                name: title,
                min: 0,
                max: 100
            },
            series: [{
                data: values,
                type: 'line',
                smooth: true,
                lineStyle: { width: 2 },
                markLine: {
                    silent: true,
                    data: markLines
                }
            }],
            visualMap: thresholds.highThresholdValue != null && thresholds.lowThresholdValue != null ? {
                show: false,
                dimension: 1, // é’ˆå¯¹ y å€¼åšåˆ¤æ–­
                pieces: [
                    { lt: thresholds.lowThresholdValue, color: '#2196f3' }, // è“è‰²ï¼ˆä½äºé˜ˆå€¼ï¼‰
                    { gte: thresholds.lowThresholdValue, lte: thresholds.highThresholdValue, color: '#3f51b5' }, // æ­£å¸¸
                    { gt: thresholds.highThresholdValue, color: '#f44336' } // çº¢è‰²ï¼ˆé«˜äºé˜ˆå€¼ï¼‰
                ]
            } : undefined
        };

        myChart.setOption(option);

        // å¤„ç†æŠ¥è­¦æç¤ºï¼ˆå³ä¸Šè§’ï¼‰
        const alarmNode = chartDom.querySelector('.alarm');
        if (alarmNode) {
            chartDom.removeChild(alarmNode);  // ç§»é™¤æ—§çš„è­¦å‘Š
        }

        // åªä½¿ç”¨æœ€åä¸€æ¡æ•°æ®æ¥åˆ¤æ–­
        const lastValue = values[values.length - 1];

        // åˆ¤æ–­æ˜¯å¦éœ€è¦æ˜¾ç¤ºè­¦å‘Š
        let alarmMessage = '';
        let alarmStyle = '';
        if (lastValue > thresholds.highThresholdValue) {
            alarmMessage = `âš ï¸ é«˜é˜ˆå€¼è­¦å‘Šï¼`;
            alarmStyle = 'rgba(255, 0, 0, 0.7)';
        } else if (lastValue < thresholds.lowThresholdValue) {
            alarmMessage = `âš ï¸ ä½é˜ˆå€¼è­¦å‘Šï¼`;
            alarmStyle = 'rgba(0, 0, 255, 0.7)';
        }

        // å¦‚æœæœ‰è­¦å‘Šï¼Œåˆ™æ˜¾ç¤ºå¹¶é—ªçƒ
        if (alarmMessage) {
            const alarmNode = document.createElement('div');
            alarmNode.className = 'alarm blink'; // æ·»åŠ é—ªçƒåŠ¨ç”»ç±»
            alarmNode.style.fontSize = '16px';  // å­—ä½“å¤§å°
            alarmNode.innerText = alarmMessage;
            alarmNode.style.backgroundColor = alarmStyle;
            chartDom.appendChild(alarmNode);
        }
    }

    // åŠ è½½æˆ¿é—´ä¿¡æ¯ï¼ˆå¦‚æˆ¿é—´åç§°ï¼‰
    async function loadRoomInfo() {
        const res = await fetch(`/api/rooms/${roomId}`);
        const room = await res.json();
        document.getElementById("roomTitle").innerText = `æˆ¿é—´ï¼š${room.roomName}ï¼ˆID: ${roomId}ï¼‰`;
    }

    // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨å¹¶æ¸²æŸ“
    async function initCharts() {
        await loadRoomInfo();
        const thresholds = await fetchThresholds();
        const thMap = {};
        thresholds.forEach(t => thMap[t.thresholdType] = t);

        // è·å–å„ä¼ æ„Ÿå™¨çš„æ•°æ®å¹¶æ¸²æŸ“å›¾è¡¨
        for (const cfg of chartConfigs) {
            const data = await fetchSensorData(cfg.sensorType);
            renderChart(cfg.id, cfg.name, data.reverse(), thMap[cfg.sensorType]);

            // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®
            setInterval(async () => {
                const updatedData = await fetchSensorData(cfg.sensorType);
                renderChart(cfg.id, cfg.name, updatedData.reverse(), thMap[cfg.sensorType]);
            }, 1000);  // æ¯ç§’æ›´æ–°ä¸€æ¬¡
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å›¾è¡¨
    window.onload = () => {
        initCharts();
    };

    // è®¾ç½®é¡µé¢æŒ‰é’®é“¾æ¥
    document.getElementById("backBtn").href = `roomDetail.html?roomId=${roomId}`;
</script>
</body>
</html>
