<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>æˆ¿é—´è¯¦æƒ…</title>
    <style>
        body { font-family: sans-serif; background: #f4f6f9; margin: 0; }
        header { background-color: #3f51b5; color: white; padding: 16px; font-size: 20px; text-align: center; position: relative; }
        .container { padding: 20px; }
        h2 { margin-top: 0; }
        .device-form {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .device-form label {
            font-weight: bold;
            margin-left: 8px;
        }
        .device-form select, .device-form input, .device-form button {
            padding: 8px;
            border-radius: 4px;
            font-size: 16px;
        }
        button { background-color: #3f51b5; color: white; border: none; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        .action-btns button { margin: 0 4px; }

        .header-buttons-left {
            position: absolute; left: 20px; top: 16px;
        }
        .header-buttons-left a {
            margin-right: 10px; color: white; text-decoration: none;
            padding: 6px 12px; border-radius: 4px;
        }
        .header-buttons-left #backBtn { background: #607d8b; }

        .header-buttons-right {
            position: absolute; right: 20px; top: 16px;
        }
        .header-buttons-right a {
            margin-left: 10px; color: white; text-decoration: none;
            padding: 6px 12px; border-radius: 4px;
        }
        .header-buttons-right #thresholdBtn { background: #ff9800; }
        .header-buttons-right #dataBtn { background: #009688; }
        .header-buttons-right #preferenceBtn { background: #4caf50; }
    </style>
</head>
<body>
<header>
    ğŸ“‹ æˆ¿é—´è¯¦æƒ…
    <div class="header-buttons-left">
        <a id="backBtn" href="#">ğŸ”™ è¿”å›</a>
    </div>
    <div class="header-buttons-right">
        <a id="dataBtn" href="#">ğŸ“¦ ä¼ æ„Ÿå™¨æ•°æ®å¯è§†åŒ–</a>
        <a id="thresholdBtn" href="#">âš™ï¸ é˜ˆå€¼ç®¡ç†</a>
        <a id="preferenceBtn" href="#">ğŸŒŸ åå¥½ç®¡ç†</a>
    </div>
</header>

<div class="container">
    <h2 id="roomTitle">åŠ è½½ä¸­...</h2>
    <div class="device-form">
        <label for="deviceId">è®¾å¤‡IDï¼š</label>
        <input type="text" id="deviceId" placeholder="è¯·è¾“å…¥è®¾å¤‡ID" />

        <label for="deviceName">è®¾å¤‡åç§°ï¼š</label>
        <input type="text" id="deviceName" placeholder="è¯·è¾“å…¥è®¾å¤‡åç§°" />

        <label for="deviceType">è®¾å¤‡ç±»å‹ï¼š</label>
        <select id="deviceType">
            <option value="light">ç¯å…‰</option>
            <option value="fan">é£æ‰‡</option>
            <option value="ac">ç©ºè°ƒ</option>
            <option value="curtain">çª—å¸˜</option>
            <option value="other">å…¶ä»–</option>
        </select>

        <button id="submitBtn" onclick="addDevice()">æ·»åŠ è®¾å¤‡</button>
    </div>

    <table>
        <thead>
        <tr>
            <th>è®¾å¤‡ID</th>
            <th>è®¾å¤‡åç§°</th>
            <th>è®¾å¤‡ç±»å‹</th>
            <th>è®¾å¤‡çŠ¶æ€</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th>æ›´æ–°æ—¶é—´</th>
            <th>æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="deviceList">
        <!-- è®¾å¤‡æ•°æ®æ¸²æŸ“åŒºåŸŸ -->
        </tbody>
    </table>
</div>

<script>

    //è½¬æ¢æ—¶é—´æ ¼å¼
    function formatDate(isoString) {
        const date = new Date(isoString);  // åˆ›å»ºä¸€ä¸ª Date å¯¹è±¡
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');  // æœˆä»½ä»0å¼€å§‹ï¼Œæ‰€ä»¥åŠ 1
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');

        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get("roomId");
    let currentRoom = {};

    // åŠ è½½æˆ¿é—´åŸºæœ¬ä¿¡æ¯
    async function loadRoomInfo() {
        const res = await fetch(`/api/rooms/${roomId}`);
        currentRoom = await res.json();
        document.getElementById("roomTitle").innerText = `æˆ¿é—´ï¼š${currentRoom.roomName}ï¼ˆID: ${roomId}ï¼‰`;
    }

    // åŠ è½½æˆ¿é—´ä¸‹çš„æ‰€æœ‰è®¾å¤‡åˆ—è¡¨
    async function loadDevices() {
        const res = await fetch(`/api/devices/room/${roomId}`);
        const devices = await res.json();
        const list = document.getElementById("deviceList");
        list.innerHTML = "";

        devices.forEach(dev => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${dev.deviceId}</td>
                <td>${dev.deviceName}</td>
                <td>${dev.deviceType}</td>
                <td>${dev.deviceStatus}</td>
                <td>${formatDate(dev.createdAt)}</td>
                <td>${formatDate(dev.updatedAt)}</td>
                <td class="action-btns">
                    <button onclick="editDevice('${dev.deviceId}')">ç¼–è¾‘</button>
                    <button onclick="deleteDevice('${dev.deviceId}')">åˆ é™¤</button>
                    <button onclick="toggleDevice('${dev.deviceId}')">${dev.deviceStatus === 'on' ? 'å…³é—­' : 'å¼€å¯'}</button>
                </td>`;
            list.appendChild(row);
        });
    }

    // æ·»åŠ è®¾å¤‡
    async function addDevice() {
        const deviceId = document.getElementById("deviceId").value.trim();
        const deviceName = document.getElementById("deviceName").value.trim();
        const deviceType = document.getElementById("deviceType").value;

        if (!deviceId || !deviceName || !deviceType) {
            alert("è¯·è¾“å…¥å®Œæ•´çš„è®¾å¤‡ä¿¡æ¯");
            return;
        }

        const payload = { deviceId, deviceName, deviceType };
        const res = await fetch(`/api/devices/${roomId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            alert("æ“ä½œå¤±è´¥");
            return;
        }

        // æ¸…ç©ºè¡¨å•
        document.getElementById("deviceId").value = "";
        document.getElementById("deviceName").value = "";
        document.getElementById("deviceType").value = "";

        loadDevices();
    }

    // ç¼–è¾‘è®¾å¤‡ï¼Œè¡¨å•å¡«å……å½“å‰è®¾å¤‡ä¿¡æ¯
    async function editDevice(deviceId) {
        const res = await fetch(`/api/devices/${deviceId}`);
        const device = await res.json();

        document.getElementById("deviceId").value = device.deviceId;
        document.getElementById("deviceName").value = device.deviceName;
        document.getElementById("deviceType").value = device.deviceType;

        // ä¿®æ”¹æŒ‰é’®æ–‡æœ¬ä¸ºæ›´æ–°
        document.querySelector(".device-form button").innerText = "æ›´æ–°è®¾å¤‡";
        document.querySelector(".device-form button").onclick = () => updateDevice(device.deviceId);
    }

    // æ›´æ–°è®¾å¤‡æ“ä½œ
    async function updateDevice(deviceId) {
        const deviceName = document.getElementById("deviceName").value.trim();
        const deviceType = document.getElementById("deviceType").value;

        const payload = { deviceId, deviceName, deviceType };
        const res = await fetch(`/api/devices/${roomId}/${deviceId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            loadDevices();
            // é‡ç½®è¡¨å•å¹¶æ¢å¤æŒ‰é’®ä¸ºæ·»åŠ æ¨¡å¼
            document.getElementById("deviceId").value = "";
            document.getElementById("deviceName").value = "";
            document.getElementById("deviceType").value = "";
            document.querySelector(".device-form button").innerText = "æ·»åŠ è®¾å¤‡";
            document.querySelector(".device-form button").onclick = addDevice;
        } else {
            alert("æ›´æ–°å¤±è´¥");
        }
    }

    // åˆ é™¤è®¾å¤‡
    async function deleteDevice(deviceId) {
        if (!confirm("ç¡®è®¤åˆ é™¤æ­¤è®¾å¤‡ï¼Ÿ")) return;
        const res = await fetch(`/api/devices/${deviceId}`, { method: "DELETE" });
        if (res.ok) {
            loadDevices();
        } else {
            alert("åˆ é™¤å¤±è´¥");
        }
    }

    // åˆ‡æ¢è®¾å¤‡çŠ¶æ€ï¼ˆå¼€/å…³ï¼‰
    async function toggleDevice(deviceId) {
        const res = await fetch(`/api/devices/${deviceId}/toggle`, { method: "POST" });
        if (res.ok) {
            loadDevices();
        } else {
            alert("æ“ä½œå¤±è´¥");
        }
    }

    // åˆå§‹åŒ–åŠ è½½
    window.onload = function() {
        loadRoomInfo();
        loadDevices();
        setInterval(loadDevices, 1000); // æ¯ç§’åˆ·æ–°ä¸€æ¬¡è®¾å¤‡åˆ—è¡¨
    }

    // è®¾ç½®é¡µé¢æŒ‰é’®é“¾æ¥
    document.getElementById("backBtn").href = "index.html";
    document.getElementById("dataBtn").href = `roomData.html?roomId=${roomId}`;
    document.getElementById("thresholdBtn").href = `thresholdManagement.html?roomId=${roomId}`;
    document.getElementById("preferenceBtn").href = `preferenceManagement.html?roomId=${roomId}`;
</script>
</body>
</html>
